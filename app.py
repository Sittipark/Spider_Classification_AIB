from fastai.vision.all import *
import glob
from random import shuffle
import streamlit as st
import pathlib
from pathlib import Path
pathlib.PosixPath = pathlib.WindowsPath

# Set custom CSS for dark theme
st.markdown("""
    <style>
    body {
        background-color: #1e1e1e;
        color: #ffffff;
    }
    .stButton>button {
        background-color: #ffffff;
        color: #ffffff;
        border: 1px solid #ffffff;
    }
    .stRadio>div {
        background-color: #ffffff;
        color: #ffffff;
        border: 1px solid #ffffff;
        border-radius: 10px;
        padding: 10px;
    }
    .stSidebar .stSelectbox, .stSidebar .stFileUploader {
        background-color: #ffffff;
        color: #ffffff;
        border: 1px solid #ffffff;
    }
    </style>
""", unsafe_allow_html=True)

# Set app title with a red spider logo
st.markdown("<h1 style='color:#ff0000;text-align:center;'>üï∑Ô∏è SPIDER CLASSIFICATION üï∑Ô∏è</h1>", unsafe_allow_html=True)

# Load model
path = Path()
learn_inf = load_learner(path/'vgg19_model_2.pkl', cpu=True)

def get_spider_info(spider_name):
    spider_info = {
        "black_widow": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡πÅ‡∏°‡πà‡∏°‡πà‡∏≤‡∏¢‡∏î‡∏≥ (Black Widow) ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏©‡∏£‡πâ‡∏≤‡∏¢‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏¢‡πÑ‡∏î‡πâ* ‡∏û‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å ‡∏ï‡∏±‡∏ß‡∏™‡∏µ‡∏î‡∏≥‡∏Ç‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤‡∏ß‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡∏ö‡∏ô‡∏ó‡πâ‡∏≠‡∏á",
        "blue_tarantula": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ó‡∏≤‡∏•‡∏±‡∏ô‡∏ó‡∏π‡∏•‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (Blue Tarantula) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏ï‡∏±‡∏ß‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏≤‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏≤ ‡∏°‡∏±‡∏Å‡∏û‡∏ö‡πÉ‡∏ô‡∏õ‡πà‡∏≤‡∏ù‡∏ô‡πÄ‡∏Ç‡∏ï‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà",
        "bold_jumper": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î (Bold Jumper) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏û‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å ‡∏Ç‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤‡∏ß ‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏ï‡∏±‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏Å‡∏•",
        "brown_grass_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡πÅ‡∏°‡πà‡∏°‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (Brown Grass Spider) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ö‡∏ô‡∏ï‡∏±‡∏ß",
        "brown_recluse_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏™‡∏±‡∏ô‡πÇ‡∏î‡∏©‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (Brown Recluse Spider) ‡∏°‡∏µ‡∏û‡∏¥‡∏©‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏ñ‡∏∂‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï* ‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏î‡πà‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏•‡∏≤‡∏¢‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏£‡∏π‡∏õ‡πÑ‡∏ß‡πÇ‡∏≠‡∏•‡∏¥‡∏ô‡∏ö‡∏ô‡∏´‡∏•‡∏±‡∏á",
        "deinopis_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏´‡∏ß‡πà‡∏≤‡∏ô‡πÅ‡∏´ (Deinopis Spider) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏°‡∏µ‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏î‡∏ß‡∏á‡∏ï‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÇ‡∏ï",
        "golden_orb_weaver": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡πÉ‡∏¢‡∏ó‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á‡∏Ç‡∏ô‡∏≤‡∏ô (Golden Orb Weaver) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á ‡∏û‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å",
        "hobo_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á (Hobo Spider) ‡∏°‡∏µ‡∏û‡∏¥‡∏©‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏ú‡∏•‡∏û‡∏∏‡∏û‡∏≠‡∏á* ‡∏°‡∏µ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏û‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£",
        "huntsman_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏û‡πÄ‡∏ô‡∏à‡∏£ (Huntsman Spider) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏ï‡πà‡∏≠‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß ‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î ‡∏°‡∏±‡∏Å‡∏û‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏£‡πâ‡∏≠‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á‡∏™‡∏≤‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏î‡∏µ",
        "ladybird_mimic_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏á‡πÄ‡∏ï‡πà‡∏≤ (Ladybird Mimic Spider) ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏á‡πÄ‡∏ï‡πà‡∏≤ ‡∏°‡∏µ‡∏™‡∏µ‡∏™‡∏±‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏î‡πÉ‡∏™ ‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏î‡∏≥‡∏ö‡∏ô‡∏´‡∏•‡∏±‡∏á",
        "peacock_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ô‡∏Å‡∏¢‡∏π‡∏á (Peacock Spider) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å ‡∏°‡∏µ‡∏™‡∏µ‡∏™‡∏±‡∏ô‡∏™‡∏î‡πÉ‡∏™‡πÅ‡∏•‡∏∞‡∏•‡∏ß‡∏î‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏ô‡∏Å‡∏¢‡∏π‡∏á ‡∏û‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢",
        "red_knee_tarantula": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ó‡∏≤‡∏•‡∏±‡∏ô‡∏ó‡∏π‡∏•‡∏≤‡πÄ‡∏Ç‡πà‡∏≤‡πÅ‡∏î‡∏á (Red Knee Tarantula) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏ö‡∏ß‡∏° ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡∏°‡∏µ‡∏™‡∏µ‡∏î‡∏≥‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤ ‡∏°‡∏±‡∏Å‡∏û‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏£‡πâ‡∏≠‡∏ô",
        "spiny_backed_orb_weaver": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏î‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏ô‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏á‡πà‡∏á‡∏ö‡∏ô‡∏´‡∏•‡∏±‡∏á ‡∏°‡∏µ‡∏™‡∏µ‡∏™‡∏±‡∏ô‡∏™‡∏î‡πÉ‡∏™ ‡∏û‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡∏≠",
        "white_knee_tarantula": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏ó‡∏≤‡∏•‡∏±‡∏ô‡∏ó‡∏π‡∏•‡∏≤‡πÄ‡∏Ç‡πà‡∏≤‡∏Ç‡∏≤‡∏ß (White Knee Tarantula) ‡∏°‡∏µ‡∏û‡∏¥‡∏©‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡∏°‡∏µ‡∏™‡∏µ‡∏î‡∏≥‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡∏≤ ‡∏û‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÉ‡∏ï‡πâ",
        "yellow_garden_spider": "‡πÅ‡∏°‡∏á‡∏°‡∏∏‡∏°‡∏™‡∏ß‡∏ô‡∏™‡∏µ‡∏î‡∏≥‡∏ó‡∏≠‡∏á (Yellow Garden Spider) ‡∏°‡∏µ‡∏û‡∏¥‡∏© ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å ‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏™‡∏µ‡∏î‡∏≥‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏î‡πÉ‡∏™ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡∏™‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î"
    }
    return spider_info.get(spider_name, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏ö")

def predict(img, learn):
    # Make prediction
    pred, pred_idx, pred_prob = learn_inf.predict(img)
    # Get spider information
    spider_info = get_spider_info(pred)
    # Display the prediction
    st.success(f"This is {pred} with the probability of {pred_prob[pred_idx]*100:.02f}%")
    st.info(spider_info)
    # Display the test image
    st.image(img, use_column_width=True)

##################################
# Sidebar
##################################
# Sidebar title
st.sidebar.markdown("<h3>Enter spider to classify</h3>", unsafe_allow_html = True)

# Image source selection
option = st.sidebar.radio('', ['Use a validation image', 'Use your own image'])
valid_images = glob.glob('SPIDER_DATASET/valid/*/*')
shuffle(valid_images)

if option == 'Use a validation image':
    st.sidebar.write('### Select a validation image')
    fname = st.sidebar.selectbox('', valid_images)
    img = PILImage.create(fname)
else:
    st.sidebar.write('### Select an image to upload')
    uploaded_file = st.sidebar.file_uploader('', type = ['png', 'jpg', 'jpeg'], accept_multiple_files = False)
    if uploaded_file is not None:
        img = PILImage.create(uploaded_file)
    else:
        img = PILImage.create(valid_images[0])

# Infer
if img:
    predict(img, learn_inf)
